<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
 <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Anime Blogs</title>

  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
   <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
   <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <style>
:root {
  --bg-light: #fff;
  --text-light: #000;
  --card-light: #f9f9f9;
  --shadow-light: rgba(0,0,0,0.1);
  --bg-dark: #121212;
  --text-dark: #fff;
  --card-dark: #111;
  --shadow-dark: rgba(255,255,255,0.1);
  --radius: 8px;
  --transition: 0.3s;
}
   body {
      margin: 0; font-family: Arial, sans-serif;
      background: var(--bg-dark);
      color: var(--text-light);
      transition: background var(--transition), color var(--transition);
    }
     header {
      display: flex; justify-content: space-between; align-items: center;
      padding: 1rem;
      background: var(--card-light);
      box-shadow: 0 2px 4px var(--shadow-dark);
      transition: background var(--transition), box-shadow var(--transition);
    }

    body.dark header {
      background: var(--card-light);
      box-shadow: 0 2px 4px var(--shadow-light);
    }

/* Navbar */
.navbar {
  padding: 12px 20px;
  display: flex;
  align-items: center;
  transition: background 0.3s;
}
.nav-container {
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  justify-content: space-between;
  background-color: var(--nav-bg);
  padding: 10px;
}

/* Responsive fix */
@media (max-width: 600px) {
  .navbar {
    flex-direction: column;
    align-items: flex-start;
    gap: 10px;
  }

  .nav-container {
    flex-direction: column;
    gap: 10px;
  }
}


.navbar .logo {
  font-size: 20px;
  font-weight: bold;
}

/* Dark Theme */
body.dark-mode {
  background-color: #121212;
  color: #eee;
}
body.dark-mode .navbar {
  background-color: #1f1f1f;
}
body.dark-mod {
  color: #eee;
}
     h1 {
      text-align: center;
      padding: 20px;
      color: #f1e313;
 
    }

    nav {
      display: flex; align-items: center; gap: 1rem;
    }

    .search-bar {
      display: flex; align-items: center; gap: 0.2rem;
    }

    .search-bar input {
        display: flex;
      padding: 12px; font-size: 17px;
      border: 1px solid #ccc; border-radius: 4px;
      outline: none;
      transition: border-color 0.2s;
      justify-content:space-evenly;
    }
        .search-bar select { 
          display: flex;
          justify-content: space-evenly;
          font-size: 14px;
          padding: 3px;

        }

    .search-bar input:focus,
    .search-bar select:focus {
      border-color: #111;
    }

    .search-bar button {
      cursor: pointer;
      background: transparent;
      border: none;
      font-size: 1rem;
      color: var(--text-light);
      transition: color 0.3s;
    }
     
      .tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 10px 0;
    }
    .tag {
      background: #333;
      padding: 6px 12px;
      border-radius: 20px;
      cursor: pointer;
    }
    .tag.active {
      background: #ffcc00;
      color: black;
    }

    .controls {
      padding: 0.2rem;
    }
    body.dark .search-bar button {
      color: var(--text-dark);
    }

.blog-list-btn {
  background: #fff;
  color: #111;
  padding: 10px;
  border-radius: 50%;
  border: none;
  font-size: 18px;
  cursor: pointer;
  text-decoration: none;
  display: inline-flex;
  align-items: center;
  justify-content: center;
}

.blog-list-btn:hover {
  background:  #111;
  color: white;
}

    .theme-toggle {
      cursor: pointer;
      padding: 2px;
      font-size: 1.3rem;
      background: #ddd;
      color: #111;
      transition: color 0.3s;
      border-radius: 15%;
    }
    .theme-toggle a.hover{
      background: #111;
      color: #555;

    }

    body.dark .theme-toggle {
      color: var(--text-dark);
    }

    main.blog-container {
      padding: 1rem;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1rem;
    }
     
     .scroll-container {
      display: flex;
      overflow-x: auto;
      gap: 15px;
      padding: 0 20px 10px;
     }
    
    .blog-card img {
      width: 100%;
      height: 150px;
      object-fit: cover;
      border-radius: 8px;
    }

    body.dark .blog-card {
      background: var(--card-dark);
      box-shadow: 0 2px 8px var(--shadow-dark);
    }
        
    .blog-card img {
      width: 100%;
      height: 150px;
      object-fit: cover;
      border-radius: 8px;
    }
    .blog-card h3 {
      color: #f0c404;
      margin: 10px 0 5px;
      font-size: 1.5rem;
    }
    .blog-card p {
      font-size: 0.9rem;
      line-height: 1.4;
    }
    .blog-card  {
      text-decoration: none;
      color: #fdc50b;
      background: #fff;
      padding: 6px 10px;
      display: inline-block;
      border-radius: 4px;
      margin-top: 10px;
      font-weight: bold;
    }

    .blog-content {
      padding: 0.75rem 1rem;
      flex-grow: 1;
    }

    .blog-content h3 {
      margin: 0 0 0.5rem 0;
      font-size: 1.2rem;
    }

    .blog-content p {
      margin: 0;
      font-size: 0.95rem;
      color: #555;
    }

    body.dark .blog-content p {
      color: #ccc;
    }

    .blog-actions {
      padding: 0.5rem 1rem 1rem;
      font-size: 0.9rem;
      color: #888;
      display: flex; gap: 1rem;
      align-items: center;
    }

    body.dark .blog-actions {
      color: #aaa;
    }

    .blog-actions span {
      display: flex; align-items: center; gap: 0.3rem;
      user-select: none;
    }

    .blog-actions i {
      color: red;
    }

    .read-more-btn {
      margin-top: 0.5rem;
      background: #007bff;
      color: #fff;
      border: none;
      padding:  0.6rem;
      border-radius: 9px;
      cursor: pointer;
      font-weight: bold;
      transition: background 0.3s;
      width: 35%;
    }

    .read-more-btn:hover {
      background: #0056b3;
    }

    #modal {
      position: fixed;
      bottom: 1rem;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.75);
      color: #fff;
      padding: 0.5rem 1rem;
      border-radius: 5px;
      display: none;
      z-index: 5000;
      font-weight: bold;
      user-select: none;
    }

    #blogOverlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.85);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 10000;
      padding: 1rem;
    }

    #blogOverlay.flex {
      display: flex;
    }

    .content-wrapper {
      background: var(--bg-light);
      color: var(--text-light);
      max-width: 800px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      border-radius: var(--radius);
      padding: 1rem 1.5rem;
      position: relative;
      box-shadow: 0 0 15px rgba(0,0,0,0.4);
      transition: background var(--transition), color var(--transition);
    }

    body.dark .content-wrapper {
      background: var(--bg-dark);
      color: var(--text-dark);
    }


    .close-btn {
  position: absolute;
  top: 0.8rem;
  right: 0.8rem;
  background: #fff;
  border: none;
  font-size: 1.4rem;
  color: #000;
  cursor: pointer;
  border-radius: 50%;
  width: 36px;
  height: 36px;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 2px 6px rgba(0,0,0,0.3);
  transition: background 0.3s;
}
.close-btn:hover {
  background: #111;
  color: #fff;
}

    .banner {
      width: 100%;
      border-radius: var(--radius);
      object-fit: cover;
      max-height: 300px;
    }

    .full-content {
      margin-top: 2rem;
      line-height: 1.5;
    }

    .btn-group {
      display: flex;
    }

    .btn-group button {
      padding: 0.5rem;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      transition: background 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.3rem;
    }
     
    #likeBtn {
  margin: 5px;
  padding: 10px;
  font-size: 12px;
  border-radius: 12px;
}
#commentToggleBtn {
  margin: 5px;
  padding: 10px;
  font-size: 12px;
  border-radius: 12px;
}
.ratingstars {
  margin-top: 20px;
}

    .btn-like {
      background: #ca180b;
      color: #fff;
    }

    .btn-like:hover {
      background:#aa1f15;
    }

    .btn-comment {
      background: #222;
      color: white;
    }

    .btn-comment:hover {
      background: #444;
    }

    .btn-share {
      background: #4caf50;
      color: white;
    }

    .btn-share:hover {
      background: #357a38;
    }

    #commentsSection {
      margin-top: 1rem;
    }

    #commentsSection.hidden {
      display: none;
    }
   
    #commentList {
      max-height: 150px;
      overflow-y: auto;
      border: 1px solid #ccc;
      padding: 0.5rem;
      border-radius: 5px;
      background: var(--card-light);
      margin-bottom: 0.5rem;
    }

    body.dark #commentList {
      background: var(--card-dark);
      border-color: #555;
    }

    .comment-item {
      border-bottom: 1px solid #ddd;
      padding: 0.3rem 0;
      font-size: 0.9rem;
    }

    body.dark .comment-item {
      border-color: #444;
    }

    #commentInput {
      width: 100%;
      padding: 0.5rem;
      border-radius: 13px;
      border: 1px solid #ccc;
      resize: vertical;
      font-family: inherit;
    }

    body.dark #commentInput {
      border-color: #555;
      background: #111;
      color: #fff;
    }

    #postCommentBtn {
      margin-top: 0.3rem;
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 5px;
      background: black;
      color: white;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.3s;
      user-select: none;
    }

    #postCommentBtn:disabled {
      background: #fff;
      cursor: not-allowed;
    }

    /* Share Popup */
.share-popup {
  display: none;
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.6);
  z-index: 9999;
  justify-content: center;
  align-items: center;
}
.share-links a,
.share-links button {
  display: block;
  margin: 10px 0;
  text-decoration: none;
  padding: 10px;
  background: #f1f1f1;
  border-radius: 5px;
  color: black;
}

    body.dark #sharePopup {
      background: var(--card-dark);
      color: var(--text-dark);
      box-shadow: 0 0 10px var(--shadow-dark);
    }

.share-content {
  background: white;
  border-radius: 10px;
  padding: 20px;
  max-width: 400px;
  width: 90%;
  text-align: center;
  box-shadow: 0 0 20px rgba(0,0,0,0.3);
}
.share-options {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  justify-content: center;
  padding: 15px;
  border-radius: 12px;
  background-color: white;
  box-shadow: 0 2px 10px rgba(0,0,0,0.15);
}

.share-options a {
  width: 80px;
  padding: 10px;
  background: #f3f3f3;
  border-radius: 10px;
  text-align: center;
  text-decoration: none;
  color: #000;
  font-size: 13px;
  transition: 0.3s;
}

.share-options a i {
  font-size: 22px;
}

/* Specific platform colors */
#shareWhatsApp i { color: #25D366; }
#shareFacebook i { color: #3b5998; }
#shareTwitter i { color: #1DA1F2; }
#shareInstagram i { color: #C13584; }
#shareDrive i { color: #4285F4; }
#shareSnapchat i { color: #FFFC00; }
#shareGoogle i { color: #DB4437; }
#shareChatGPT i { color: #10a37f; }
#shareCopy i { color: #333; }

.share-options a:hover {
  background: #ddd;
}
.share-options a img,
.share-options a span {
  display: block;
  margin: auto;
}
#shareBtn {
  margin: 5px;
  padding: 10px;
  font-size: 12px;
  border-radius: 12px;
}
      .back-btn {
      margin-top: 1px;
      display: inline-block;
      text-decoration: none;
      color: var(--text);
      font-weight: bold;
      margin-bottom: 15px;
      padding: 1rem;
      font-size: 10px;
    }
   

    .blog-item {
  background: white;
  border-radius: 8px;
  box-shadow: 0 0 10px rgba(0,0,0,0.1);
  width: 280px;           /* fixed width ya minmax agar grid use kar rahe ho */
  padding: 15px;
  box-sizing: border-box;
  display: flex;
  flex-direction: column;
}

    #Listblog {
  display: flex;          /* ya grid agar chahe to */
  flex-wrap: wrap;
  gap: 20px;
  justify-content: center; /* ya left, right */
  padding: 10px;
}

  .modal.hidden { display: none; }
.modal {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0, 0, 0, 0.6); z-index: 9999;
  display: flex; justify-content: center; align-items: center;
}
.modal-content {
  background: #fff; padding: 20px; border-radius: 10px;
  text-align: center; width: 90%; max-width: 350px;
}
.modal-content button {
  margin: 5px; padding: 8px 16px; background: #ffc107; border: none;
  border-radius: 5px; cursor: pointer;
}
    .loader-ring {
  border: 6px solid #f3f3f3; /* light grey */
  border-top: 6px solid red; /* red ring top */
  border-radius: 50%;
  width: 30px;
  height: 30px;
  animation: spin 1s linear infinite;
  margin: 50px auto;
  display: none; /* hidden by default */
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

  </style>
</head>
<body>
 <!-- Navbar -->
<nav class="navbar">
      <div id="modal" role="alert" aria-live="assertive"></div>
      <div class="search-bar">
      <input type="text" id="searchInput" placeholder="Search blogs..." style="padding: 10px; width: 100%; max-width: 400px; border-radius: 8px; border: 1px solid #ccc; margin: 10px auto; display: block;" />
<div id="blogContainer"></div>
        </button>
        <div class="controls">
  <select id="sortBy">
    <option value="">Sort by</option>
    <option value="latest">Latest</option>
    <option value="liked">Most Liked</option>
  </select>
        <select id="filterTag" aria-label="Filter blog by tag" title="Filter by Tag">
          <option value="">All Tags</option>
          <option value="Sad">Sad</option>
          <option value="Love">Love</option>
          <option value="Action">Action</option>
          <option value="Darama">Fantasy</option>
          <option value="Fight">Fight</option>
          <option value="Comedy">Comedy</option>
        </select>
         <div id="output"></div>
      </div>
  <div id="Listblog"></div>
<!-- Modal box -->
<div id="modalMsg" class="modal hidden">
  <div class="modal-content">
    <p id="modalText"></p>
    <div id="modalBtns"></div>
  </div>
</div>
<a href="blog-list.html" class="blog-list-btn" title="Blog List">
  <i class="fas fa-list"></i>
</a>
      <i id="themeToggleBtn" class="fas fa-moon theme-toggle" title="Toggle Dark/Light Theme" role="button" tabindex="0" aria-pressed="false"></i>
    </nav>
  </header>
  </div>
  <hr>
  <main id="blogList" class="blog-container" aria-live="polite" aria-label="List of anime blogs">
  <p style="grid-column: 1 / -1; text-align: center;"></p>
</main>

  <section id="blogOverlay" aria-modal="true" role="dialog" aria-labelledby="overlayTitle" aria-hidden="true">
    <div class="content-wrapper">
      <button class="close-btn" aria-label="Close blog details">&times;</button>
      <img class="banner" src="" alt="Blog banner" />
      <div class="header">
        <h2 id="overlayTitle"></h2>
      </div>
      <div class="full-content"></div>
      <div class="btn-group">
  <button id="likeBtn" class="btn-like"><i class="fas fa-heart"></i> Like (<span id="likeCount">0</span>)</button>
  <button id="commentToggleBtn" class="btn-comment"><i class="fas fa-comments"></i> Comments (<span id="commentCount">0</span>)</button>
  <button id="shareBtn" class="btn-share"><i class="fas fa-share-alt"></i> Share (<span id="shareeCount">0</span>)</button>
</div>
<!-- Share Popup -->
<div id="sharePopup" class="share-popup">
  <div class="share-content">
    <h3>Share this blog</h3>
    <div class="share-options">
      <a id="shareWhatsApp" target="_blank"><i class="fab fa-whatsapp"></i><span>WhatsApp</span></a>
      <a id="shareFacebook" target="_blank"><i class="fab fa-facebook"></i><span>Facebook</span></a>
      <a id="shareTwitter" target="_blank"><i class="fab fa-twitter"></i><span>Twitter</span></a>
      <a id="shareInstagram" target="_blank"><i class="fab fa-instagram"></i><span>Instagram</span></a>
      <a id="shareDrive" target="_blank"><i class="fab fa-google-drive"></i><span>Drive</span></a>
      <a id="shareSnapchat" target="_blank"><i class="fab fa-snapchat"></i><span>Snapchat</span></a>
      <a id="shareGoogle" target="_blank"><i class="fab fa-google"></i><span>Google</span></a>
      <a id="shareChatGPT" href="#" target="_blank" style="text-align:center">
  <img src="https://upload.wikimedia.org/wikipedia/commons/0/04/ChatGPT_logo.svg" alt="ChatGPT Icon" width="30" height="30" style="margin-bottom:5px;">
  <div style="font-size: 12px;">ChatGPT</div>
</a>
      <a id="shareCopy" data-url="#"><i class="fas fa-copy"></i><span>Copy Link</span></a>
    </div>
  </div>
</div>


      <div class="blog-full-content">
  <div id="fullContent"></div>

  <!-- ⭐ Rating Stars -->
<div id="ratingstars" class="ratingstars">
<div id="rating" class="rating">
  <i data-star="1" class="star far fa-star"></i>
  <i data-star="2" class="star far fa-star"></i>
  <i data-star="3" class="star far fa-star"></i>
  <i data-star="4" class="star far fa-star"></i>
  <i data-star="5" class="star far fa-star"></i>
</div>

<p id="ratingText"></p>

  </div>
</div>

      <section id="commentsSection" class="hidden" aria-label="Comments section">
        <h4>Comments</h4>
        <div id="commentList" tabindex="0"></div>
        <div class="add-comment">
          <textarea id="commentInput" placeholder="Write your comment..." aria-label="Write your comment"></textarea>
          <button id="postCommentBtn" disabled>Post</button>
        </div>
      </section>
    </div>
  </section>

  <script type="module">
    function getGuestId() {
  let id = localStorage.getItem("guestId");
  if (!id) {
    id = "guest_" + Date.now() + "_" + Math.floor(Math.random() * 10000);
    localStorage.setItem("guestId", id);
  }
  return id;
}

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {getFirestore, collection, getDocs, doc, addDoc , getDoc, updateDoc, increment, arrayUnion } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBsSEaxwAsWigHfs9FHhtmJlntU-MeSIOs",
      authDomain: "animeblog-87e80.firebaseapp.com",
      projectId: "animeblog-87e80",
      storageBucket: "animeblog-87e80.appspot.com",
      messagingSenderId: "353731840842",
      appId: "1:353731840842:web:c684581140433d2ebc4fb3"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // DOM elements
    const blogList = document.getElementById("blogList");
    const overlay = document.getElementById("blogOverlay");
    const overlayTitle = document.getElementById("overlayTitle");
    const overlayBanner = document.querySelector(".banner");
    const fullContent = document.querySelector(".full-content");
    const likeCountSpan = document.getElementById("likeCount");
    const likeBtnFull = document.getElementById("likeBtn");
    const commentToggleBtn = document.getElementById("commentToggleBtn");
    const commentsSection = document.getElementById("commentsSection");
    const commentList = document.getElementById("commentList");
    const commentInput = document.getElementById("commentInput");
    const postCommentBtn = document.getElementById("postCommentBtn");
    const ratingstars = document.getElementById("ratingstars");
    const userRatingText = document.getElementById("userRatingText");
    let ratingElements = ratingstars.querySelectorAll("i");
    const shareBtn = document.getElementById("shareBtn");
    const sharePopup = document.getElementById("sharePopup");
    const shareWhatsApp = document.getElementById("shareWhatsApp");
    const shareFacebook = document.getElementById("shareFacebook");
    const shareTwitter = document.getElementById("shareTwitter");
    const shareInstagram = document.getElementById("shareInstagram");
    const shareDrive = document.getElementById("shareDrive");
    const sharePhotos = document.getElementById("sharePhotos");
    const shareSnapchat = document.getElementById("shareSnapchat");
    const shareGoogle = document.getElementById("shareGoogle");
    const shareChatGPT = document.getElementById("shareChatGPT");
    const shareCopy = document.getElementById("shareCopy");
    const modal = document.getElementById("modal");
    const filterTag = document.getElementById("filterTag");
    const searchInput = document.getElementById("searchInput");
    const blogContainer = document.getElementById("blogContainer");
    const themeToggleBtn = document.getElementById("themeToggleBtn");
    const loginLink = document.querySelector(".login a");

    let allBlogs = [];
    let filteredBlogs = [];
    let comments = [];
    let userRating = 0;
    let currentBlogId = new URLSearchParams(window.location.search).get("blog");
  

   function getFormattedDate() {
  const now = new Date();
  const dd = String(now.getDate()).padStart(2, '0');
  const mm = String(now.getMonth() + 1).padStart(2, '0'); // Month is 0-based
  const yyyy = now.getFullYear();
  return `${dd}-${mm}-${yyyy}`;
}


    // Toast modal message
    function showModalMessage(msg) {
      modal.textContent = msg;
      modal.style.display = "block";
      setTimeout(() => { modal.style.display = "none"; }, 2500);
    }
    
    
    // Theme toggle
    function loadTheme() {
      const saved = localStorage.getItem("darkTheme");
      if (saved === "true") {
        document.body.classList.add("dark");
        themeToggleBtn.classList.replace("fa-moon", "fa-sun");
        themeToggleBtn.setAttribute("aria-pressed", "true");
      }
    }
    function toggleTheme() {
      const isDark = document.body.classList.toggle("dark");
      if (isDark) {
        themeToggleBtn.classList.replace("fa-moon", "fa-sun");
        themeToggleBtn.setAttribute("aria-pressed", "true");
        localStorage.setItem("darkTheme", "true");
      } else {
        themeToggleBtn.classList.replace("fa-sun", "fa-moon");
        themeToggleBtn.setAttribute("aria-pressed", "false");
        localStorage.setItem("darkTheme", "false");
      }
    }
    themeToggleBtn.addEventListener("click", toggleTheme);
    themeToggleBtn.addEventListener("keydown", e => {
      if(e.key === "Enter" || e.key === " ") toggleTheme();
    });
    loadTheme();
   
    

    // Fetch blogs from Firestore
    async function fetchBlogs() {
      try {
        const snapshot = await getDocs(collection(db, "blogs"));
        allBlogs = [];
        snapshot.forEach(docSnap => {
          const data = docSnap.data();
          allBlogs.push({ id: docSnap.id, ...data });
        });
        filteredBlogs = [...allBlogs];
        renderBlogs();
      } catch (e) {
        showModalMessage("Failed to load blogs");
        console.error(e);
      }
    }

    // Render blogs in grid
function renderBlogs() {
  blogList.innerHTML = "";

  if (filteredBlogs.length === 0) {
    blogList.innerHTML = "<p style='grid-column:1/-1;text-align:center;'>No blogs found.</p>";
    return;
  }

  filteredBlogs.forEach(blog => {
    const likeKey = `liked_${blog.id}`;
    const liked = localStorage.getItem(likeKey); // ✅ Check if liked

    const card = document.createElement("article");
    card.className = "blog-card";
    card.innerHTML = `
      <img src="${blog.banner || 'https://via.placeholder.com/300x180?text=No+Image'}" alt="Banner for ${blog.title}" />
      <div class="blog-content">
        <h2>${blog.title}</h2>
        <p>${blog.intro || ""}</p>
        <button class="read-more-btn" aria-label="Read more about ${blog.title}">Read More</button>
      </div>
      <div class="blog-actions" aria-label="Blog stats">
        <span title="Likes">
          <i class="fas fa-heart" style="color:${liked ? 'red' : 'gray'};"></i> ${blog.likes || 0}
        </span>
        <span title="Comments"><i class="fas fa-comments"></i> ${blog.comments?.length || 0}</span>
        <span title="Shares"><i class="fas fa-share-alt"></i> ${blog.shares || 0}</span>
      </div>
    `;

    card.querySelector(".read-more-btn").addEventListener("click", () => openFullBlog(blog.id));
    blogList.appendChild(card);
  });
}


// ESC key to close overlay
document.addEventListener("keydown", (e) => {
  if (e.key === "Escape" && overlay.classList.contains("flex")) {
    overlay.classList.remove("flex");
    overlay.setAttribute("aria-hidden", "true");
    commentsSection.classList.add("hidden");
    commentInput.value = "";
    postCommentBtn.disabled = true;
    sharePopup.style.display = "none";
  }
});

    // Filter and search blogs
document.getElementById("searchInput").addEventListener("input", function () {
  const searchText = this.value.toLowerCase();
  const cards = document.querySelectorAll(".blog-card");

  cards.forEach((card) => {
    const title = card.querySelector("h2").textContent.toLowerCase();
    card.style.display = title.includes(searchText) ? "block" : "none";
  });
});



// Open full blog overlay
async function openFullBlog(blogId) {
  console.log("openFullBlog called with blogId:", blogId);
  currentBlogId = blogId;
  try {
    const docRef = doc(db, "blogs", blogId);
    const docSnap = await getDoc(docRef);

    if (!docSnap.exists()) {
      showModalMessage("Blog not found");
      console.warn("No such blog document for id:", blogId);
      return;
    }

    const blog = docSnap.data();
    console.log("Blog data:", blog);

    // Set overlay content
    overlayTitle.textContent = blog.title || "No Title";
    overlayBanner.src = blog.banner || "https://via.placeholder.com/800x300?text=No+Image";
    fullContent.innerHTML = blog.full || "<p>No content available.</p>";

    // Update likes and comments counts
    likeCountSpan.textContent = blog.likes || 0;
    commentToggleBtn.querySelector("span").textContent = (blog.comments && blog.comments.length) || 0;

    // Reset like button color (white or gray)
    const likeIcon = document.querySelector(".btn-like i");
    if (localStorage.getItem(`liked_${blogId}`)) {
      likeIcon.style.color = "red";
    } else {
      likeIcon.style.color = "white";
    }

    // Load comments from blog data
    comments = blog.comments || [];
    renderComments();

    // Show overlay
    overlay.classList.add("flex");
    overlay.setAttribute("aria-hidden", "false");

    // Initialize rating stars system
   currentBlogId = blogId;
   initRating(blogId);      // ⭐ Start rating stars
   loadUserRating(blogId);  // ⭐ Show old rating if exists


  } catch (error) {
    console.error("Error loading blog:", error);
    showModalMessage("Error loading blog");
  }
}


    // Close overlay
    document.querySelector(".close-btn").addEventListener("click", () => {
      overlay.classList.remove("flex");
      overlay.setAttribute("aria-hidden", "true");
      commentsSection.classList.add("hidden");
      commentInput.value = "";
      postCommentBtn.disabled = true;
      sharePopup.style.display = "none";
    });

    // Like button
 const likeBtn = document.getElementById("likeBtn");
likeBtn.addEventListener("click", async () => {
  if (!currentBlogId) return;

  const likeKey = `liked_${currentBlogId}`;
  if (localStorage.getItem(likeKey)) {
    showModalMessage("⚠️ Already liked!");
    return;
  }

  try {
    const blogRef = doc(db, "blogs", currentBlogId);
    await updateDoc(blogRef, {
      likes: increment(1)
    });

    localStorage.setItem(likeKey, "true"); // ✅ Save user like locally
    let newLikes = parseInt(likeCountSpan.textContent) + 1;
    likeCountSpan.textContent = newLikes;
    showModalMessage("❤️ Thanks for liking!");
  } catch (e) {
    console.error(e);
    showModalMessage("❌ Failed to like");
  }
});


    // Comments toggle button
    commentToggleBtn.addEventListener("click", () => {
      if (commentsSection.classList.contains("hidden")) {
        commentsSection.classList.remove("hidden");
      } else {
        commentsSection.classList.add("hidden");
      }
    });

    // Render comments in overlay
    function renderComments() {
      commentList.innerHTML = "";
      if (comments.length === 0) {
        commentList.innerHTML = "<p>No comments yet.</p>";
        return;
      }
      comments.forEach(c => {
        const div = document.createElement("div");
        div.className = "comment-item";
        div.textContent = c;
        commentList.appendChild(div);
      });
    }

    // Enable/disable post button on input
    commentInput.addEventListener("input", () => {
      postCommentBtn.disabled = commentInput.value.trim() === "";
    });

    // Post comment
    postCommentBtn.addEventListener("click", async () => {
      if (!currentBlogId) return;
      const commentText = commentInput.value.trim();
      if (commentText === "") return;

      const blogRef = doc(db, "blogs", currentBlogId);

      try {
        // Add comment to array
        await updateDoc(blogRef, {
          comments: arrayUnion(commentText)
        });
        comments.push(commentText);
        renderComments();
        commentInput.value = "";
        postCommentBtn.disabled = true;
        commentToggleBtn.querySelector("span").textContent = comments.length;
        showModalMessage("Comment added!");
      } catch (e) {
        console.error(e);
        showModalMessage("Failed to add comment");
      }
    });

    // Share button toggle popup
    shareBtn.addEventListener("click", () => {
      if (sharePopup.style.display === "block") {
        sharePopup.style.display = "none";
      } else {
        sharePopup.style.display = "block";
      }
    });
  
    // Share links update
 function updateShareLinks() {
  const url = window.location.href;
  document.getElementById("shareWhatsApp").href = `https://api.whatsapp.com/send?text=${encodeURIComponent(url)}`;
  document.getElementById("shareFacebook").href = `https://facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`;
  document.getElementById("shareTwitter").href = `https://twitter.com/intent/tweet?url=${encodeURIComponent(url)}`;
  document.getElementById("shareInstagram").href = `https://www.instagram.com/`;
  document.getElementById("shareDrive").href = `https://drive.google.com/`;
  document.getElementById("shareSnapchat").href = `https://www.snapchat.com/`;
  document.getElementById("shareGoogle").href = `https://www.google.com/`;
  document.getElementById("shareChatGPT").href = `https://chat.openai.com/`;
  shareCopy.setAttribute("data-url", url);
}

shareBtn.addEventListener("click", () => {
  updateShareLinks();
  sharePopup.style.display = "flex";
});

sharePopup.addEventListener("click", (e) => {
  if (e.target === sharePopup) {
    sharePopup.style.display = "none";
  }
});


    // Copy share link
shareCopy.addEventListener("click", () => {
  const url = shareCopy.getAttribute("data-url");
  navigator.clipboard.writeText(url).then(() => {
    alert("Link copied to clipboard!");
    sharePopup.style.display = "none";
  });
});


    // On page load
    fetchBlogs();


     
    // ✅ ADD THIS LINE AT THE END
window.addEventListener("beforeunload", (e) => {
  if (overlay.classList.contains("flex")) {
    e.preventDefault();
    e.returnValue = '';
  }
});
    
    // Check for blog query parameter
    const urlParams = new URLSearchParams(window.location.search);
   
   // ⭐ initRating(blogId) function
  function getRatingKey(blogId) {
  return `rated_${blogId}`;
}

function highlightStars(rating) {
  const stars = document.querySelectorAll(".rating i");
  stars.forEach((star, index) => {
    if(index < rating) {
      star.classList.add("fas");
      star.classList.remove("far");
      star.style.color = "#ffc107";
    } else {
      star.classList.remove("fas");
      star.classList.add("far");
      star.style.color = "";
    }
  });
}

function loadUserRating(blogId) {
  const saved = localStorage.getItem(getRatingKey(blogId));
  if(saved) {
    highlightStars(parseInt(saved));
    document.getElementById("ratingText").textContent = `You rated this ${saved} ★`;
  } else {
    highlightStars(0);
    document.getElementById("ratingText").textContent = "";
  }
}

function initRating(blogId) {
  const stars = document.querySelectorAll(".rating i");
  const ratingKey = getRatingKey(blogId);

  console.log("Stars found:", stars.length); // Debug line

  stars.forEach(star => {
    star.style.cursor = "pointer";  // Show pointer on hover
    star.onclick = async () => {
      if(localStorage.getItem(ratingKey)) {
        alert("You already rated this blog");
        return;
      }

      const rating = parseInt(star.dataset.star);
      if(isNaN(rating)) {
        alert("Rating data-star attribute missing!");
        return;
      }

      // Save rating in Firestore
      try {
        await addDoc(collection(db, "ratings"), {
          blogId,
          rating,
          timestamp: Date.now()
        });

        localStorage.setItem(ratingKey, rating);
        highlightStars(rating);
        document.getElementById("ratingText").textContent = `You rated this ${rating} ★`;
        alert("Thanks for rating!");
      } catch(e) {
        console.error(e);
        alert("Error saving rating.");
      }
    }
  });

  loadUserRating(blogId);
}

// Show loader
document.getElementById("loader").style.display = "block";

// Simulate data loading (like Firebase fetching)
setTimeout(() => {
  document.getElementById("loader").style.display = "none";
  // Yahan tumhara content display hoga
}, 3000); // 3 sec delay just for demo


    //
    const blogId = urlParams.get("blog");
    if (blogId) {
      openFullBlog(blogId);
    }

    sortBy.addEventListener("change", () => {
  const option = sortBy.value;

  if (option === "latest") {
    filteredBlogs.sort((a, b) => b.timestamp - a.timestamp);
  } else if (option === "liked") {
    filteredBlogs.sort((a, b) => (b.likes || 0) - (a.likes || 0));
  }

  renderBlogs();
});
     // Yeh Firebase khud current date aur time daal dega.
  createdAt: firebase.database.ServerValue.TIMESTAMP


    // naya upar dikhega
    db.collection("blogs")
  .orderBy("createdAt", "desc") // Latest blog pehle
  .get()
  .then((querySnapshot) => {
    querySnapshot.forEach((doc) => {
      console.log(doc.data().title);
    });
  });

    // Modal functions
  function showModal(message, options = {}) {
    const modal = document.getElementById('modalMsg');
    const text = document.getElementById('modalText');
    const buttons = document.getElementById('modalBtns');

    text.innerText = message;
    buttons.innerHTML = '';
    modal.classList.remove('hidden');

    if (options.buttons) {
      options.buttons.forEach(btn => {
        const button = document.createElement('button');
        button.innerText = btn.text;
        button.onclick = () => {
          modal.classList.add('hidden');
          if (btn.onClick) btn.onClick();
        };
        buttons.appendChild(button);
      });
    } else {
      setTimeout(() => {
        modal.classList.add('hidden');
      }, options.duration || 2000);
    }
  }

  // Real-time fetch and display blogs
  function listenBlogs() {
    db.collection('blogs').orderBy('createdAt', 'desc').onSnapshot(snapshot => {
      const blogList = document.getElementById('blogList');
      blogList.innerHTML = ''; // clear old

      snapshot.forEach(doc => {
        const blog = doc.data();
        const id = doc.id;

        const div = document.createElement('div');
        div.className = 'blog-item';
        div.innerHTML = `
          <h3>${blog.title}</h3>
          <p>${blog.content.substring(0, 120)}...</p>
          <button onclick="likeBlog('${id}')">👍 Like</button>
          <button onclick="rateBlog('${id}', 5)">⭐ Rate 5</button>
          <button onclick="shareBlog('${id}')">🔗 Share</button>
          <button onclick="commentBlog('${id}')">💬 Comment</button>
        `;
        blogList.appendChild(div);
      });
    });
  }

  // Like blog with modal feedback & check for already liked by user
  // Note: For demo, userID simulated with localStorage
  const userId = localStorage.getItem('anonId') || (() => {
    const id = 'user_' + Math.random().toString(36).slice(2, 9);
    localStorage.setItem('anonId', id);
    return id;
  })();

  function likeBlog(blogId) {
    const likeRef = db.collection('likes').doc(blogId).collection('users').doc(userId);
    likeRef.get().then(doc => {
      if (doc.exists) {
        showModal('You already liked this blog.');
      } else {
        likeRef.set({ likedAt: firebase.firestore.FieldValue.serverTimestamp() })
          .then(() => showModal('Thanks for liking the blog!'));
      }
    }).catch(() => showModal('Network error! Please try again.'));
  }

  // Rate blog - similar logic
  function rateBlog(blogId, rating) {
    if (!rating || rating < 1 || rating > 5) {
      showModal('Please provide a rating between 1 and 5.');
      return;
    }

    const rateRef = db.collection('ratings').doc(blogId).collection('users').doc(userId);
    rateRef.get().then(doc => {
      if (doc.exists) {
        showModal('You already rated this blog.');
      } else {
        rateRef.set({ rating, ratedAt: firebase.firestore.FieldValue.serverTimestamp() })
          .then(() => showModal('Thank you for rating!'));
      }
    }).catch(() => showModal('Network error! Please try again.'));
  }

  // Share blog modal (example)
  function shareBlog(blogId) {
    // For demo, just show modal
    showModal('Thanks for sharing the blog!');
  }

  // Comment blog (example modal message)
  function commentBlog(blogId) {
    // This can open a comment box etc.
    showModal('Comment feature coming soon!');
  }

  // Network check modal
  function checkInternet() {
    if (!navigator.onLine) {
      showModal('Please check your internet connection.');
    } else {
      showModal('Internet connection is active.', { duration: 1500 });
    }
  }

  // Exit confirmation modal
  function confirmExit() {
    showModal('Are you sure you want to exit AnimeFlix?', {
      buttons: [
        { text: 'Yes', onClick: () => window.close() },
        { text: 'No' }
      ]
    });
  }

  // Start listening blogs when page loads
  window.onload = listenBlogs;

  </script>
  <div id="loader" class="loader-ring"></div>
</body>
</html>
